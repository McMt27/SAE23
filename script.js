// Attend que le DOM soit enti√®rement charg√© avant d'ex√©cuter le script
document.addEventListener("DOMContentLoaded", function () {
    // R√©cup√©ration des √©l√©ments HTML par leurs IDs
    const codePostalInput = document.getElementById("code-postal");
    const communeSelect = document.getElementById("selection-commune");
    const boutonRecherche = document.getElementById("bouton-recherche");
    const nombreJoursSlider = document.getElementById("nombre-jours");
    const nombreJoursActuel = document.querySelector(".nombre-jours-actuel");
    const previsionsContainer = document.getElementById("previsions-container");
    const joursLabels = document.querySelectorAll(".jour-label");
    
    // Initialisation du slider de nombre de jours
    initSliderJours();
    
    // Ajout d'un √©couteur d'√©v√©nement sur l'input du code postal
    codePostalInput.addEventListener("input", async function () {
        const codePostal = codePostalInput.value;
        
        // V√©rification que le code postal est compos√© de 5 chiffres
        if (/^\d{5}$/.test(codePostal)) {
            // Si valide, recherche les communes correspondantes
            await rechercherCommunes(codePostal);
        } else {    
            // Sinon, r√©initialise le select des communes et d√©sactive les √©l√©ments
            communeSelect.innerHTML = '<option value="">S√©lectionnez une commune</option>';
            communeSelect.disabled = true;
            boutonRecherche.disabled = true;
        }
    });
    
    // Fonction pour initialiser le slider de nombre de jours
    function initSliderJours() {
        // √âcouteur pour le changement de valeur du slider
        nombreJoursSlider.addEventListener("input", function() {
            const valeur = this.value;
            nombreJoursActuel.textContent = valeur;
            
            // Mise √† jour des labels actifs
            joursLabels.forEach(label => {
                label.classList.remove("active");
                if (label.dataset.jour === valeur) {
                    label.classList.add("active");
                }
            });
            
            // Mise √† jour visuelle du slider
            updateSliderVisuel();
        });
        
        // √âcouteurs pour les labels cliquables
        joursLabels.forEach(label => {
            label.addEventListener("click", function() {
                const jour = this.dataset.jour;
                nombreJoursSlider.value = jour;
                nombreJoursActuel.textContent = jour;
                
                // Mise √† jour des classes actives
                joursLabels.forEach(l => l.classList.remove("active"));
                this.classList.add("active");
                
                // Mise √† jour visuelle du slider
                updateSliderVisuel();
            });
        });
        
        // Initialisation visuelle
        updateSliderVisuel();
    }
    
    // Fonction pour mettre √† jour l'apparence visuelle du slider
    function updateSliderVisuel() {
        const valeur = nombreJoursSlider.value;
        const max = nombreJoursSlider.max;
        const pourcentage = ((valeur - 1) / (max - 1)) * 100;
        
        // Mise √† jour de la fill du slider
        const sliderFill = document.querySelector(".slider-fill");
        if (sliderFill) {
            sliderFill.style.width = pourcentage + "%";
        }
        
        // Mise √† jour du thumb
        const sliderThumb = document.querySelector(".slider-thumb");
        if (sliderThumb) {
            sliderThumb.style.left = pourcentage + "%";
        }
    }
    
    // Fonction asynchrone pour r√©cup√©rer les communes √† partir d'un code postal
    async function rechercherCommunes(codePostal) {
        // URL de l'API Geo Gouv pour r√©cup√©rer les communes par code postal
        const url = `https://geo.api.gouv.fr/communes?codePostal=${codePostal}&fields=nom,code`;
        
        try {
            // Appel √† l'API
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.length > 0) {
                // Si des communes sont trouv√©es, r√©initialise et remplit le select
                communeSelect.innerHTML = '<option value="">S√©lectionnez une commune</option>';
                
                // Parcourt chaque commune retourn√©e et cr√©e une option pour le select
                data.forEach(commune => {
                    const option = document.createElement("option");
                    option.value = commune.code; // Code INSEE comme valeur
                    option.textContent = commune.nom;
                    communeSelect.appendChild(option);
                });
                
                // Active le select des communes
                communeSelect.disabled = false;
            } else {
                // Si aucune commune n'est trouv√©e, affiche un message et d√©sactive le select
                communeSelect.innerHTML = '<option value="">Aucune commune trouv√©e</option>';
                communeSelect.disabled = true;
            }
            
        } catch (error) {
            // Gestion des erreurs lors de l'appel API
            console.error("Erreur lors de la r√©cup√©ration des communes :", error);
        }
    }
    
    // √âcouteur d'√©v√©nement sur le changement de s√©lection de commune
    communeSelect.addEventListener("change", function () {
        // Active ou d√©sactive le bouton de recherche selon qu'une commune est s√©lectionn√©e
        boutonRecherche.disabled = !communeSelect.value;
    });
    
    // √âcouteur d'√©v√©nement sur le clic du bouton de recherche
    boutonRecherche.addEventListener("click", function (event) {
        event.preventDefault(); // Emp√™che le comportement par d√©faut du formulaire
        if (communeSelect.value) {
            // Si une commune est s√©lectionn√©e, lance la recherche m√©t√©o
            const nombreJours = parseInt(nombreJoursSlider.value);
            rechercheMeteo(communeSelect.value, nombreJours);
        }
    });
    
    // Fonction asynchrone pour r√©cup√©rer les donn√©es m√©t√©o d'une commune
    async function rechercheMeteo(codeInsee, nombreJours = 1) {
        // Token d'authentification pour l'API M√©t√©o Concept
        const token = "8dbccf25d154d5362923efe8d3222f64f86689170efa3686df676d2941cc7d08";
        // URL de l'API avec le code INSEE et le token
        const url = `https://api.meteo-concept.com/api/forecast/daily?insee=${codeInsee}&token=${token}`;
        
        try {
            // Affichage d'un indicateur de chargement
            afficherChargement();
            
            // Appel √† l'API m√©t√©o
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.forecast && data.forecast.length > 0) {
                // Affichage des pr√©visions pour le nombre de jours demand√©
                afficherPrevisions(data.forecast.slice(0, nombreJours), data.city);
            } else {
                // Si aucune donn√©e m√©t√©o n'est disponible, affiche un message d'erreur
                afficherMessageErreur("Aucune donn√©e m√©t√©o disponible.");
            }
            
        } catch (error) {
            // Gestion des erreurs lors de l'appel API m√©t√©o
            console.error("Erreur lors de la r√©cup√©ration de la m√©t√©o :", error);
            afficherMessageErreur("Erreur de r√©cup√©ration de la m√©t√©o.");
        }
    }
    
    // Fonction pour afficher un indicateur de chargement
    function afficherChargement() {
        previsionsContainer.innerHTML = `
            <div class="chargement">
                <div class="spinner"></div>
                <p>Chargement des pr√©visions...</p>
            </div>
        `;
    }
    
    // Fonction pour afficher les pr√©visions m√©t√©o sur plusieurs jours
    function afficherPrevisions(forecasts, cityInfo) {
        // Vide le conteneur pr√©c√©dent
        previsionsContainer.innerHTML = '';
        
        // Cr√©ation de l'en-t√™te avec informations de la ville
        const enTete = document.createElement('div');
        enTete.className = 'previsions-entete';
        enTete.innerHTML = `
            <h3>üìç ${cityInfo.name}</h3>
            <p class="info-ville">Pr√©visions pour ${forecasts.length} jour(s)</p>
        `;
        previsionsContainer.appendChild(enTete);
        
        // Cr√©ation du conteneur grille pour les jours
        const grilleJours = document.createElement('div');
        grilleJours.className = 'grille-jours';
        
        // Parcourt chaque pr√©vision et cr√©e une carte
        forecasts.forEach((forecast, index) => {
            const carteJour = creerCarteJour(forecast, index);
            grilleJours.appendChild(carteJour);
        });
        
        previsionsContainer.appendChild(grilleJours);
    }
    
    // Fonction pour cr√©er une carte de pr√©vision pour un jour
    function creerCarteJour(forecast, index) {
        // Conversion de la date
        const date = new Date(forecast.datetime);
        const options = { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long' 
        };
        const dateFormatee = date.toLocaleDateString('fr-FR', options);
        
        // D√©termination du titre du jour
        let titreJour;
        if (index === 0) {
            titreJour = "Aujourd'hui";
        } else if (index === 1) {
            titreJour = "Demain";
        } else {
            titreJour = dateFormatee.split(' ')[0]; // Jour de la semaine
        }
        
        // Obtention de l'ic√¥ne m√©t√©o
        const iconeMeteo = obtenirIconeMeteo(forecast.weather);
        
        // Cr√©ation de l'√©l√©ment carte
        const carte = document.createElement('div');
        carte.className = 'carte-jour';
        carte.innerHTML = `
            <div class="jour-header">
                <h4 class="jour-titre">${titreJour}</h4>
                <p class="jour-date">${dateFormatee}</p>
            </div>
            <div class="jour-icone">
                ${iconeMeteo}
            </div>
            <div class="jour-temperatures">
                <span class="temp-max">${forecast.tmax}¬∞</span>
                <span class="temp-min">${forecast.tmin}¬∞</span>
            </div>
            <div class="jour-details">
                <div class="detail-item">
                    <span class="detail-icone">üåßÔ∏è</span>
                    <span class="detail-valeur">${forecast.probarain ?? 0}%</span>
                </div>
                <div class="detail-item">
                    <span class="detail-icone">‚òÄÔ∏è</span>
                    <span class="detail-valeur">${forecast.sun_hours ?? 0}h</span>
                </div>
            </div>
        `;
        
        return carte;
    }
    
    // Fonction pour obtenir l'ic√¥ne m√©t√©o appropri√©e
    function obtenirIconeMeteo(weather) {
        const icones = {
            0: "‚òÄÔ∏è", // Soleil
            1: "üå§Ô∏è", // Peu nuageux
            2: "‚õÖ", // Ciel voil√©
            3: "üå•Ô∏è", // Nuageux
            4: "‚òÅÔ∏è", // Tr√®s nuageux
            5: "üå¶Ô∏è", // Couvert
            6: "üåßÔ∏è", // Brouillard
            7: "üåßÔ∏è", // Brouillard givrant
            10: "üå¶Ô∏è", // Pluie faible
            11: "üåßÔ∏è", // Pluie mod√©r√©e
            12: "‚õàÔ∏è", // Pluie forte
            13: "üå¶Ô∏è", // Pluie faible vergla√ßante
            14: "üåßÔ∏è", // Pluie mod√©r√©e vergla√ßante
            15: "‚õàÔ∏è", // Pluie forte vergla√ßante
            16: "üå®Ô∏è", // Bruine
            20: "‚ùÑÔ∏è", // Neige faible
            21: "üå®Ô∏è", // Neige mod√©r√©e
            22: "üå®Ô∏è‚ùÑÔ∏è", // Neige forte
            30: "‚õàÔ∏è", // Pluie et neige m√™l√©es faibles
            31: "‚õàÔ∏è", // Pluie et neige m√™l√©es mod√©r√©es
            32: "‚õàÔ∏è", // Pluie et neige m√™l√©es fortes
            40: "‚õàÔ∏è", // Averses de pluie faible
            41: "‚õàÔ∏è", // Averses de pluie mod√©r√©e
            42: "‚õàÔ∏è", // Averses de pluie forte
            43: "‚õàÔ∏è", // Averses de pluie faible et neige m√™l√©es
            44: "‚õàÔ∏è", // Averses de pluie mod√©r√©e et neige m√™l√©es
            45: "‚õàÔ∏è", // Averses de pluie forte et neige m√™l√©es
            60: "‚ùÑÔ∏è", // Averses de neige faible
            61: "üå®Ô∏è", // Averses de neige mod√©r√©e
            62: "üå®Ô∏è‚ùÑÔ∏è", // Averses de neige forte
            70: "‚õàÔ∏è", // Orages faibles et locaux
            71: "‚õàÔ∏è", // Orages mod√©r√©s et locaux
            72: "‚õàÔ∏è", // Orages fort et locaux
            73: "‚õàÔ∏è", // Orages faibles g√©n√©ralis√©s
            74: "‚õàÔ∏è", // Orages mod√©r√©s g√©n√©ralis√©s
            75: "‚õàÔ∏è", // Orages forts g√©n√©ralis√©s
        };
        
        return icones[weather] || "üå´Ô∏è";
    }
    
    // Fonction pour afficher un message d'erreur
    function afficherMessageErreur(message) {
        previsionsContainer.innerHTML = `
            <div class="message-erreur">
                <div class="erreur-icone">‚ö†Ô∏è</div>
                <h3>Oops ! Une erreur s'est produite</h3>
                <p>${message}</p>
                <button class="bouton-retry" onclick="window.location.reload()">
                    R√©essayer
                </button>
            </div>
        `;
    }
});